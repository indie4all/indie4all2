!function(){const a=io();var t=window.location.pathname.split("/");const i=t[t.length-3],r=i+"-studentlist",d=i+"-step";let l=JSON.parse(sessionStorage.getItem(r))||{};a.emit("join-room",i,"teacher");function c(){$(".gamification-steps").find(".gamification-current-step").each(function(){const t=$(this).parent();$(this).removeClass("gamification-current-step");const e=t.children();e.eq(u).addClass("gamification-current-step"),e.length===u+1&&$("#bstep-"+i).addClass("d-none")})}function m(){if(0===Object.keys(l).length)return[];let t=Object.keys(l).map(t=>{var e=l[t],t=e.answered;return{id:e.id,username:e.username,time:t?e.time:0,score:t?e.score:0,total:e?.total||0,res:!!t&&e.res}});t.sort((t,e)=>t.time-e.time);var e=t.filter(t=>1===t.score);let i=(0<e.length?e:t)[0].time,s=t[t.length-1].time,n=t.map((t,e,n)=>{let a={...t};a.points=1e3*a.score;t=i===s?0:.2*a.points*(Math.max(0,a.time-i)/(s-i));return a.points=Math.round(a.points-t),a.total+=a.points,a});return n.sort((t,e)=>e.total-t.total),n}let u=JSON.parse(sessionStorage.getItem(d))||0,p;a.on("hello",(t,e)=>{a.emit("ack",{id:t,step:u,questions:p}),l[t]||(l[t]={id:t,username:e},sessionStorage.setItem(r,JSON.stringify(l)),$("#student-count").html(Object.keys(l).length))}),a.on("update-user-list",t=>{var e,n,a,i;t.step===u&&(e=t.id,n=t.res,a=t.username,i=t.time,t=t.score,t={...l[e],id:e,res:n,username:a,time:i,score:t,answered:!0},l[e]=t,sessionStorage.setItem(r,JSON.stringify(l)),$("#student-count").html(Object.keys(l).length))});function n(t,s){var e=`
        <div class="gamification-participants">
            <div id="student-count" class="student-circle">0</div>
            <button type="button" id="student-list-button"
                aria-label="${s("gamification-display-student-list")}"
                class="btn btn-dark rounded-0 text-white pr-3 pl-3"
                data-bs-toggle="popover" data-trigger="focus" data-placement="left">
                <i class="fas fa-user fa-3x" aria-hidden="true"></i>
            </button>
        </div>
        <div class="gamification-close">
            <button type="button" id="bgam-${i}" aria-label="${s("gamification-finish")}"
                    class="btn btn-dark rounded-0 text-white pr-3 pl-3 pb-2 pt-2">
            <i class="fas fa-trophy fa-2x fa-fw" aria-hidden="true"></i>
            </button>
        </div>
        <div class="gamification-step d-none">
            <button type="button" id="bstep-${i}" aria-label="${s("gamification-next")}"
                    class="btn btn-dark rounded-0 text-white pr-3 pl-3 pb-2 pt-2">
            <i class="fas fa-arrow-right fa-2x fa-fw" aria-hidden="true"></i>
            </button>
        </div>`;function n(a){let e=$("#gamification-message-modal");function n(t){t.find(".gamification-ranking").remove();let e=o(a);var n=s("gamification-ranking");t.find(".modal-title").html(n),t.find(".modal-body").append(e),e.delay(1500).show(700),setTimeout(function(){t.removeClass("changing")},100)}if(e.hasClass("show")){let t=e.clone();e.css("opacity",0),setTimeout(function(){e.remove()},300),t.addClass("changing"),n(t),bootstrap.Modal.getOrCreateInstance(t[0],{keyboard:!0,focus:!0,backdrop:!1}).show();const i=t[0].addEventListener("hidden.bs.modal",function(){$(".gamification-current-step").first().attr("tabindex","-1").focus(),t[0].removeEventListener("hidden.bs.modal",i)})}else{e.addClass("changing"),n(e),bootstrap.Modal.getOrCreateInstance(e[0],{keyboard:!0,focus:!0,backdrop:!1}).show();const t=e[0].addEventListener("hidden.bs.modal",function(){$(".gamification-current-step").first().attr("tabindex","-1").focus(),e[0].removeEventListener("hidden.bs.modal",t)})}}let o=function(t){t.sort((t,e)=>e.total-t.total);var e=t.map(function(t,e){var n=$("<td />").html(e+1),a=$("<td />").html(t.username),e=$("<td />").html(t.points),t=$("<td />").html(t.total);return $("<tr />").append(n,a,e,t)}),n=$("<tr />").append($("<th />").attr("colspan",4).html(s("gamification-results"))),t=$("<tr />").append($("<th />").html(s("gamification-position")),$("<th />").html(s("gamification-username")),$("<th />").html(s("gamification-points")),$("<th />").html(s("gamification-total"))),t=$("<thead />").append(n,t),e=$("<tbody />").html(e);return $("<table/>").addClass("gamification-ranking table mx-auto").append(t,e)};$("#showcodgane").append("https://game.upct.es/"+i+"/"),$("#student-count").html(Object.keys(l).length),$("#body").height($(document).height()),$("#student-list-div").html(e),$(".gamification-step").toggleClass("d-none",0===$(".gamification-steps").length),$("#student-list-button").popover({trigger:"focus",html:!0,content:function(){let t=$("<div />").attr("id","student-list").addClass("list-group list-group-flush border-bottom scrollarea");for(var e in l){const n=$("<div />").addClass("list-group-item list-group-item-action py-3 lh-tight"),a=$("<strong />").addClass("mb-1").html(l[e].username);l[e].answered&&(e=$("<i />").attr("aria-label",s("gamification-answered")).addClass("fas fa-check-circle fa-fw text-success ms-1"),a.append(e)),n.append(a),t.append(n)}return t}}),$("#student-count").html(Object.keys(l).length),$(document).on("click","#bstep-"+i,()=>$("#modalStep").modal("show")),$(document).on("click","#bgam-"+i,()=>$("#modalConfirmacion").modal("show")),$("#step-btn-no").on("click",()=>$("#modalStep").modal("hide")),$("#modal-btn-no").on("click",()=>$("#modalConfirmacion").modal("hide")),$("#step-btn-si").on("click",()=>{!function(){let t=m();u++,Object.entries(l).forEach(([,e])=>{e.answered=!1,e.total=t.find(t=>t.id===e.id)?.total||0}),n(t),c(),sessionStorage.setItem(d,u),sessionStorage.setItem(r,JSON.stringify(l)),a.emit("game-step",{student_list:t,room:i,step:u})}(),$(".resultado:visible").empty(),$("#modalStep").modal("hide")}),$("#modal-btn-si").on("click",function(){var t;t=m(),sessionStorage.removeItem(r,JSON.stringify(l)),sessionStorage.setItem("indie-asignedstudentlist",JSON.stringify(t)),a.emit("game-finished",{student_list:t,room:i}),window.location.replace("/ranking/?cod="+i),$("#modalConfirmacion").modal("hide")}),$(document).on("gamificate",".btn-gamification",function(t,e,n){a.emit("stop-activity",{room:i})}),$(document).on("gamificate-roulette-start-teacher",".widget-roulette",function(t,e){p=e}),c()}let s=document.currentScript.src;s=s.substr(0,s.lastIndexOf("/")),$(document).ready(function(){let e=$("html").attr("lang");fetch(`${s}/../languages/${e}.json`).then(t=>t.json()).then(t=>i18next.createInstance({lng:e,resources:{[e]:{translation:t}}},n))})}();